<h1>制作发行版本</h1>


<msgqueue />

<form method='post' action="?c=org.opencomb.development.toolkit.platform.CreateDistribution" >

	<h2>发型版本信息</h2>
	<div>
		产品标题：<input type="text" name="sDistributionTitle" value="蜂巢平台" />
	</div>
	<div>
		产品名称：<input type="text" name="sDistributionName" value="oc-platform" /> 建议：避免使用中文
	</div>
	<div>
		版　　本：<input type="text" name="sDistributionVersion" value="1.0.0.0"  />
	</div>

	<h2>基础系统</h2>
	<li style="width:600px">
		JeCat框架(framework)
		version: {= \org\jecat\framework\VERSION }
		<label style="float:right">
			<input type=checkbox name="framework-debug" value='1' />
			使用开发版本（携带.git/.svn/.cvs 等版本库）
		</label>
	</li>
	
	<li style="width:600px">
		蜂巢平台(OpenComb Platform)
		version: {= \org\opencomb\platform\Platform::singleton()->version() }
		<label style="float:right">
			<input type=checkbox name="platform-debug" value='1' />
			使用开发版本（携带.git/.svn/.cvs 等版本库）
		</label>
	</li>
	
	<h2>选择扩展</h2>
	<script>
	var mapExtensionDependences = {} ;
	var mapExtensionRevertDependences = {} ;
	<foreach for='$arrExtension' item='ext'>
	mapExtensionRevertDependences['{=$ext->name()}'] = {} ;
	</foreach>
	
	function onClickExtension(sExtName,sType,wndInput)
	{
		if(wndInput.checked)
		{
			// 翻转另一个打包版本
			var mapRevertType = {
					'debug': 'release'
					, 'release': 'debug'
			} ;
			jquery('#chk-'+sExtName+'-'+mapRevertType[sType]).attr('checked',false) ;
			

			// 检查并自动选择依赖扩展
			for(var idx in mapExtensionDependences[sExtName])
			{
				var sDepenExtName = mapExtensionDependences[sExtName][idx] ;
				if( jquery('#chk-'+sDepenExtName+'-release').size()>0 )
				{
					jquery('#chk-'+sDepenExtName+'-release').attr('checked',true) ;
					// 递归
					onClickExtension(sDepenExtName,'release',jquery('#chk-'+sDepenExtName+'-release').get(0)) ;
				}
				else if( jquery('#chk-'+sDepenExtName+'-debug').size()>0 )
				{
					jquery('#chk-'+sDepenExtName+'-debug').attr('checked',true) ;
					// 递归
					onClickExtension(sDepenExtName,'debug',jquery('#chk-'+sDepenExtName+'-debug').get(0)) ;
				}
				else
				{
					alert('无法选择扩展'+sExtName+'，依赖的扩展'+sDepenExtName+'尚未打包') ;
					wndInput.checked = false ;
					return ;
				}
			}
		}
		
		else
		{
			// 反向取消扩展
			for(var sRevertDepenExtName in mapExtensionRevertDependences[sExtName])
			{
				if( jquery('#chk-'+sRevertDepenExtName+'-release').size()>0 )
				{
					jquery('#chk-'+sRevertDepenExtName+'-release').attr('checked',false) ;
					onClickExtension(sDepenExtName,'release',jquery('#chk-'+sRevertDepenExtName+'-release').get(0)) ;
				}
				if( jquery('#chk-'+sRevertDepenExtName+'-debug').size()>0 )
				{
					jquery('#chk-'+sRevertDepenExtName+'-debug').attr('checked',false) ;
					onClickExtension(sDepenExtName,'debug',jquery('#chk-'+sRevertDepenExtName+'-debug').get(0)) ;
				}
			}
			
		}
		
	}
	</script>
	<foreach for='$arrExtension' item='ext'>
	<li style="width:600px">
		<span>
			{=$ext->title()} ({=$ext->name()}:{=$ext->version()})
		</span>
		
		<span style="float:right">
			
			<if '$arrPackageState[$ext->name()][0] or $arrPackageState[$ext->name()][1]' >
			
				<if '$arrPackageState[$ext->name()][0]' >
					<label>
						<input type='checkbox' id="chk-{=$ext->name()}-release" name='arrExtensions[{=$ext->name()}]' value='{=$arrPackageState[$ext->name()][0]->path()}' onclick="onClickExtension('{=$ext->name()}','release',this) ;" />
						正式版本
					</label>
				</if>
				
				<if '$arrPackageState[$ext->name()][1]' >
					<label>
						<input type='checkbox' id="chk-{=$ext->name()}-debug" name='arrExtensions[{=$ext->name()}]' value='{=$arrPackageState[$ext->name()][1]->path()}' onclick="onClickExtension('{=$ext->name()}','debug',this) ;" />
						开发版本
					</label>
				</if>
			
			<else />
			
				<a href="?c=org.opencomb.development.toolkit.extension.ExtensionPackages">扩展尚未打包</a>
			
			</if>
			
			
		</span>
		<script>
		mapExtensionDependences['{=$ext->name()}'] = [] ;
		<foreach for="$ext->dependence()->iterator()" item="aRequire">
			<if "$aRequire->type()==\org\opencomb\platform\ext\dependence\RequireItem::TYPE_EXTENSION">
		mapExtensionDependences['{=$ext->name()}'].push('{=$aRequire->itemName()}') ;
		mapExtensionRevertDependences['{=$aRequire->itemName()}']['{=$ext->name()}'] = '{=$ext->name()}' ;
			</if>
		</foreach>
		</script>
	</li>
	</foreach>

	<div style='color:red'>若扩展尚未打包，则无法选择，请进入<a href='?c=org.opencomb.development.toolkit.extension.ExtensionPackages'>扩展打包</a>页面进行打包</div>

	<label style="display:block">
		<input type='checkbox' name='sae-package' value='1' />
		新浪云计算平台(SAE)应用包		
	</label>
	
	<label style="display:block">
		<input type='checkbox' name='single-file-installer' value='1' />
		单文件安装程序	
	</label>
		
	
	<input type='submit' value='生成安装程序' class="coresystem-form-button" />
	
</form>
