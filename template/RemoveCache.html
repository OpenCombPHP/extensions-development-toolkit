<lib name='jquery.ztree' />
<script>
jQuery(function(){
	//树数据
	classList = {=$classJson};
	//初始化树
	jQuery.fn.zTree.init(jQuery("#classTree"), {
		view: {
			expandSpeed: 0
		},
		check:{
			enable:true,
			chkboxType:{ "Y": "", "N": "" }
		},
	}, classList);
	
	var aRunningZTree = jQuery.fn.zTree.getZTreeObj("classTree");
	
	//搜索树
	jQuery('#keyWord').on('change',function(){
		var sKeyWord = jQuery.trim(jQuery(this).val());
		if(sKeyWord.length < 2){
			aRunningZTree.expandAll(false);
			aRunningZTree.cancelSelectedNode();
			return;
		}
		
		aRunningZTree.cancelSelectedNode();
		
		var arrSelectNode = aRunningZTree.getNodesByParamFuzzy('name', sKeyWord);
		aRunningZTree.expandAll(false);
		for(var i = 0 ; i< arrSelectNode.length; i++){
			aRunningZTree.selectNode(arrSelectNode[i],true);
			aRunningZTree.expandNode(arrSelectNode[i],true,false,true);
		}
		//隐藏无关树
		var nodeLis = jquery('#classTree li');
		nodeLis.show(0);
		nodeLis.each(function (){
			if(!jquery(this).find('a.curSelectedNode').size()){
				jquery(this).hide(0);
			}
		});
		//焦点回归
		jQuery(this).focus();
	});
	
	//点击清理按钮
	jQuery('#cleanSpecialCache').click(function(){
		var arrCheckedNodes = aRunningZTree.getCheckedNodes(true);
		var arrDeletePaths = [];
		//整理需要清理的路径
		for(var i = 0; i < arrCheckedNodes.length ; i++){
			arrDeletePaths.push(getPath(arrCheckedNodes[i]));
		}
		var aDelete = {deletePaths: arrDeletePaths};
		//发送到后台进行清理
		jQuery.ajax({
			url: "?c=org.opencomb.development.toolkit.platform.RemoveCache",
			type: 'post',
			data:aDelete,
			dataType: 'text',
			beforeSend : function(){
				jQuery("#cleanMessage").html("处理中...");
			},
			success: function(msg){
				jQuery("#cleanMessage").html(msg);
			}
		});
	});
	function getPath(aNode){
		var aParentNode = aNode.getParentNode();
		if( aParentNode != null){
			if(aNode.filename){
				return getPath(aParentNode)+'/'+aNode.filename;
			}else{
				return getPath(aParentNode)+'/'+aNode.name;
			}
		}else{
			return aNode.name;
		}
	}
});
</script>
<h2>删除缓存</h2>
<msgqueue />

<label>搜索: <input type="text" id="keyWord" /></label>
<div id='classTree' class='ztree'></div>
<input id="cleanSpecialCache" type="submit" class='coresystem-form-button' value='清 理'/>
<div id="cleanMessage">
</div>